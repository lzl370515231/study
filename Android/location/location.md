# 定位

商业应用中，根据不同的应用场景，室内定位技术又分消费级和工业级。

消费市场应用有：商场导购、停车场反向寻车、家人防走散等。对定位精度要求不高，1m的精度已经可以满足大多数应用，不过它要求系统兼容现已普及的移动智能终端。

企业市场应用有：人流监控和分析、智能制造、紧急救援和人员资产管理等。工业级技术的定位精度要求更高，要区分操作对象、人群中的个人等，与专用标签和传感器配套使用，一般不考虑与现有智能终端的兼容性。



## 技术门派

与室外卫星定位一统天下的情况不一样，室内定位各种技术呈现出百花齐放的场景。

![](.\png\室内定位技术.png)

## 室内定位常用方法

从原理上来说，主要分为：邻近探测法，质心法，极点法，多边定位法，指纹法和航位推算法。

| 定位方法   | 描述                                                         | 应用案例 | 特点                                   |
| ---------- | ------------------------------------------------------------ | -------- | -------------------------------------- |
| 邻近探测法 | 通过一些有范围限制的物理信号的接收，从而判断移动设备是否出现在某一个发射点附近。 | 基站定位 | 操作简单，精度不高，依赖参考点分布密度 |
| 质心定位法 | 根据移动设备可接收信号范围内所有已知的信标位置，计算其质心坐标作为移动设备的坐标 | 基站定位 | 精度不高，依赖参考点分布密度           |
| 多边定位法 | 通过测量待测目标到已知参考点之间的距离，从而确定待测目标的位置。 | 超声波   | 精度高，应用广                         |
| 极点法     | 测量相对某一已知参考点的距离和角度从而确定待测点的位置       | 激光扫描 | 测量简单，精度高，应用不广             |
| 指纹定位   | 在定位空间中建立指纹数据库，通过将实际信息与数据库中的参数进行对比来实现定位 | 地磁     | 精度高，前期工作大，不适合环境变化区域 |
| 航位推算法 | 根据预先确定的位置、估计或已知的速度和时间来估计当前的位置   | 惯性导航 | 数据稳定，无依赖，误差随时间积累       |

## 主流技术

### wifi定位技术

#### 采用“邻近法”

采用“近邻法”判断，即最靠近哪个热点或基站，即认为处在什么位置，如附近有多个信源，则可以通过交叉定位（三边定位），提高定位精度。

![](.\png\wifi-邻近法.png)

#### WIFI指纹采集

不过，WiFi热点受到周围环境的影响会比较大，精度较低。为了做得准一点有公司就做了WiFi指纹采集，事先记录巨量的确定位置点的信号强度，通过用新加入的设备的信号强度对比拥有巨量数据的数据库，来确定位置。

![](.\png\wifi-指纹采集.jpg)

由于采集工作需要大量的人员来进行，并且要定期进行维护，技术难以扩展，很少有公司能把国内的这么多商场定期的更新指纹数据。

WiFi定位可以实现复杂的大范围定位，但精度只能达到2米左右，无法做到精准定位。因此适用于对人或者车的定位导航，可以于医疗机构、主题公园、工厂、商场等各种需要定位导航的场合。

##### 代表公司

WIFISLAM、Sensewhere、图聚智能

##### 注

地磁定位技术是利用室内不同位置的地磁场差异，来确定室内位置。与WiFi指纹类似。

### 惯性导航技术

这是一种纯客户端的技术，主要利用终端惯性传感器采集的运动数据，如加速度传感器、[陀螺仪](http://www.elecfans.com/tags/陀螺仪/)等测量物体的速度、方向、加速度等信息，基于航位推测法，经过各种运算得到物体的位置信息。

![](.\png\惯性导航技术.png)

随着行走时间增加，惯性导航定位的误差也在不断累积。需要外界更高精度的数据源对其进行校准。所以现在惯性导航一般和WiFi指纹结合在一起， 每过一段时间通过WiFi请求室内位置，以此来对MEMS产生的误差进行修正。该技术目前的商用得也比较成熟，在扫地机器人中得到广泛应用。

### 蓝牙信标技术

蓝牙信标技术目前部署的也比较多，也是相对比较成熟的技术。蓝牙跟WiFi的区别不是太大，精度会比WiFi稍微高一点。

该技术最先由诺基亚最先发起，但影响不大。2013年，苹果发布了基于蓝牙4.0低功耗协议（BLE）的iBeacon协议，主要针对零售业应用，引起广泛关注。

iBeacon蓝牙信标技术的正常运作，需要蓝牙信标硬件、智能终端上的应用、云端上的应用后台协同工作。

![](.\png\蓝牙信标技术.png)

信标通过蓝牙向周围广播自身的ID，终端上的应用在获得附近信标的ID后会采取相应行动，如从云端后台拉取此ID对应的位置信息、营销资讯等。终端可以测量其所在处的接收信号强度，以此估算与信标间的距离。因此，只要终端附近有三个或以上信标，就可以用三边定位方法计算出终端的位置。

在苹果强大的号召力影响下，大量创业公司争先恐后涌入iBeacon应用的开发和推广。目前主要问题在于beacon电池更换，如果一个厂家部署了几万个beacon装置，一年之后或者电池耗尽之后的电池更换工作量是很繁重的。

##### 代表公司

Estimote、寻息电子

##### 注：

ZigBee技术和蓝牙类似，故不再作介绍。

### RFID技术

RFID定位的基本原理是，通过一组固定的阅读器读取目标RFID标签的特征信息（如身份ID、接收信号强度等），同样可以采用近邻法、多边定位法、接收信号强度等方法确定标签所在位置。

![](.\png\RFID.png)

射频识别室内定位技术作用距离很近，但它可以在几毫秒内得到厘米级定位精度的信息，且由于电磁场非视距等优点，传输范围很大，而且标识的体积比较小，造价比较低。但其不具有通信能力，抗干扰能力较差，不便于整合到其他系统之中，且用户的安全隐私保障和国际标准化都不够完善。

目前有大量成熟的商用定位方案基于RFID技术，广泛应用于紧急救援、资产管理、人员追踪等领域。

### 红外技术

#### 定位对象携带红外发射器

红外定位主要有两种具体实现方法，一种是将定位对象附上一个会发射红外线的电子标签，通过室内安放的多个红外传感器测量信号源的距离或角度，从而计算出对象所在的位置。

![](.\png\红外技术1.png)

这种方法在空旷的室内容易实现较高精度，可实现对红外辐射源的被动定位，但红外很容易被障碍物遮挡，传输距离也不长，因此需要大量密集部署传感器，造成较高的硬件和施工成本。此外红外易受热源、灯光等干扰，造成定位精度和准确度下降。

该技术目前主要用于军事上对飞行器、坦克、导弹等红外辐射源的被动定位，此外也用于室内自走机器人的位置定位。

#### 红外织网

通过多对发射器和接收器织成的红外线网覆盖待测空间，直接对运动目标进行定位。

这种方式的优势在于不需要定位对象携带任何终端或标签，隐蔽性强，常用于安防领域。劣势在于要实现精度较高的定位需要部署大量红外接收和发射器，成本非常高，因此只有高等级的安防才会采用此技术。

### 超声波技术

超声波定位主要采用反射式测距法，通过多边定位等方法确定物体位置，系统由一个主测距器和若干接收器组成，主测距仪可放置在待测目标上，接收器固定于室内环境中。定位时，向接收器发射同频率的信号，接收器接收后又反射传输给主测距器，根据回波和发射波的时间差计算出距离，从而确定位置。

![](.\png\超声波技术.png)

超声波定位整体定位精度较高，结构简单，但超声波受多径效应和非视距传播影响很大，且超声波频率受多普勒效应和温度影响，同时也需要大量基础硬件设施，成本较高。

##### 代表公司

Shopkick

### 超宽带技术

超宽带（UWB）定位技术利用事先布置好的已知位置的锚节点和桥节点，与新加入的盲节点进行通讯，并利用三角定位或者“指纹”定位方式来确定位置。

![](.\png\超宽带技术.png)

从技术上看，无论是从定位精度、安全性、抗干扰、功耗等角度来分析，UWB无疑是最理想的工业定位技术之一。 

不过UWB的劣势也很突出，一方面难以实现大范围室内覆盖，另一方面系统建设成本远高于RFID、蓝牙信标等技术，这也限制了该技术的推广和普及。

##### 代表公司

Ubisense、中海达子公司联睿电子、清华系公司清研讯科

### LED可见光技术

可见光是一个新兴领域，通过对每个LED灯进行编码，将ID调制在灯光上，灯会不断发射自己的ID，通过利用手机的前置摄像头来识别这些编码。利用所获取的识别信息在地图数据库中确定对应的位置信息，完成定位。

![](.\png\可见光技术.png)

根据灯光到达的角度进一步细化定位的结果，[高通](http://www.elecfans.com/tags/高通/)公司做到了厘米级定位精度。由于不需要额外部署基础设施，终端数量的扩大对性能没有任何的影响，并且可以达到一个非常高的精度，该技术被高通公司所看好。

目前，可见光技术在北美有很多商场已经在部署。用户下载应用后，到达商场里的某一个货架，通过检测货架周围的灯光即可知晓具体位置，商家在通过这样的方法向消费者推动商品的折扣等信息。

##### 代表公司

华策光通信

![](.\png\可见光示例.png)

### 对比

| 定位技术   | 定位精度  | 安全性 | 穿透性 | 抗干扰 | 功耗   | 辐射 | 传输距离 | 建设成本 | 应用行业   |
| ---------- | --------- | ------ | ------ | ------ | ------ | ---- | -------- | -------- | ---------- |
| WIFI       | 3-10m     | 较高   | 强     | 较强   | 高     | 较高 | 30~50m   | 较高     | 商业、工业 |
| 蓝牙       | 3-5m      | 较高   | 弱     | 弱     | 较低   | 较低 | 10m      | 较高     | 商业       |
| 地磁       | 2-5m      | 较高   | 无关   | 极弱   | 较低   | 无   | 无关     | 低       | 商业       |
| RFID       | 1-8m      | 低     | 弱     | 弱     | 低或无 | 低   | 5m       | 较高     | 商业、工业 |
| zigbee     | 3-10m     | 较低   | 弱     | 弱     | 低     | 较高 | 70m      | 较高     | 工业       |
| UWB        | 0.1-0.15m | 非常高 | 强     | 强     | 低     | 低   | 200m     | 较高     | 工业       |
| 红外       | 5-10m     | 高     | 无     | 弱     | 高     | 低   | 5m       | 高       | 工业       |
| 超声波     | 0.01-0.1m | 高     | 无     | 强     | 高     | 低   | 5m       | 极高     | 工业       |
| 计算机视觉 | 1m-2m     | 较高   | 无     | 弱     | 高     | 无   | 10m      | 高       | 商业、工业 |

#### 各技术优缺点

| 技术   | 优点                       | 缺点                         |
| ------ | -------------------------- | ---------------------------- |
| WiFi   | 网络广泛、通信能力强       | 易受环境干扰                 |
| RFID   | 成本不高、精度高           | 标识没有通信能力、距离短     |
| 蓝牙   | 设备体积小、易集成、易普及 | 传播距离短、稳定性差         |
| 惯性   | 不依赖外部环境             | 存在累计误差、不适合长期使用 |
| 红外线 | 精度高                     | 直线视距、传输距离短、易干扰 |
| 超声波 | 精度高                     | 受环境温度影响、传输距离短   |
| UWB    | 精度高、穿透性强           | 成本高、覆盖范围小           |
| 可见光 | 通讯速率高、抗干扰能力强   | 覆盖范围小                   |

### 目前面对的问题

- 室内环境复杂
- 缺乏统一的规范
- 精度与成本难以兼顾

# GPS定位

### 原理

GPS空间部分主要由24颗GPS卫星构成，其中21颗工作卫星，3颗备用卫星。24颗卫星运行在6个轨道平面上，运行周期为12个小时。保证在任一时刻、任一地点高度角15度以上都能够观测到4颗以上的卫星。

![](.\png\gps_getlocation.png)

d1、d2、d3、d4计算方式：

在发送位置信息的同时，也会附加上该数据包发出时的时间戳。GPS接收器收到数据包后，用当前时间（当前时间当然只能由GPS接收器自己来确定了）减去时间戳上的时间，就是数据包在空中传输所用的时间了。

数据包是通过无线电波传送的，那么理想速度就是光速c，把传播时间记为Ti的话，用公式表示就是：

di=c*Ti(i=1,2,3,4);

**GetLocation（函数）中多用了一组数据，正是为了来校正误差**。同时用户接收机有4个未知数（经度，纬度，高度，本地时间），通过解一个四元二次方程组即可求出接收机的坐标和时间，这样就完成了一次定位和授时。

### 分类

- 单点定位、绝对定位

- 差分定位，相对定位

  增加一个参考GPS接收器来提高定位精度。

# 基站

mcc、lac、cid等参数用于识别基站，通过数据库查询到该基站GPS位置，用收到该基站信号强度当做相对基站的距离。如果搜索到附近的基站比较多，就可以以基站的位置为圆心，以信号强度为半径进行画圆。多个基站画出圆圈重合的部分就是当前最可能的位置。

# WIFI定位

一个完整的WIFI网络系统由站、无线介质、无线接入点、分布式系统组成。

网络拓扑结构：

- 无中心拓扑结构
- 有中心拓扑结构

### WIFI信息

SSID（接入点名称）

BSSID（MAC地址）

level（信号强度）

frequency（频率）

### WiFi室内无线定位算法分类

- 信号到达的时间定位（TOA）	---圆周定位

  TOA的原理是通过无线信号的传博时间计算发射端与接收端之间的距离实现定位的。发射器在发射无线信号时，会将发射时间和位置信息添加在信号中，同事定位终端具有解析这些信息的能力。

- 信号到达的时间差定位（TDOA）    ---双曲线定位

  TDOA通过测量移动终端信号到达两个基站的时间差来进行定位。该方法通过计算两条双曲线的焦点来确定移动终端的位置信息，降低了对时钟同步的要求，但是需要额外的设备投入。

- 信号到达的角度定位（AOA）

  AOA的原理是通过移动终端接收到的发送端的信号传播角度来实现定位的。该方法同样需要知道发射端的位置信息，及两个基站到达移动终端的角度，利用三角形全等的原理，即可得到位置信息。

- 信号强度测量法（RSSI）

  - 信号传输损耗法

    传播损耗模型法是通过建立无线信号的传播损耗模型，来计算接收机与发射机之间的距离；如果预先知道发射机的位置，并计算出多个发射机与同一接收机之间的距离，就可以通过三角定位法，来确定接收机的位置信息。

    

    传播损耗模型定位法的难点是建立WiFi信号的衰减与传播距离之间的数学模型。

  - 位置指纹定位法

### 位置指纹定位法

1. 建立一个准确的指纹数据库

2. 高精度的匹配算法

   1. 概率型算法

      使用条件概率为位置指纹建立模型，然后采用贝叶斯推理机制来估算定位终端的位置。如：贝叶斯概率算法

   2. 确定型算法

      1. 最近邻法
      2. K最近邻算法
      3. 加权K近邻算法
      4. 支持向量机算法

### WIFI定位过程

![](.\png\wifi定位流程图.png)

# 室内地图与定位系统的结合

## SVG格式的矢量地图

SVG（Scalable Vector Graphics）是指可缩放的矢量图形，严格遵守可扩展标记语言（xml）,主要用于描述二维矢量图形，是一种和图像分辨率毫无关系的矢量图形格式。

#### 优势

1. 任意缩放而不失真
2. 文件较小

## SVG地图的绘制与解析

#### 绘制

1. 使用微软 Office Visio 2013 作为绘图工具，然后使用Acme TraceArt软件将 visio 图形转换为SVG格式。

#### 解析

由于SVG严格地遵守XML语言，只需要使用xml的解析器即可。

