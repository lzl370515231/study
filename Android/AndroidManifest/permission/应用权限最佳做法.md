### 应用权限最佳做法



#### Android 6.0+ 中的权限

##### 增加了情境上下文

用户对请求权限的上下文更加敏感，如果您请求的权限与应用的用途不匹配，则一定要向用户详细解释您为什么请求此权限；您应尽可能在请求时以及后续对话框中（如果用户拒绝请求）解释您的请求。

##### 在授予权限时更加灵活

用户可以在收到请求时以及在设置中拒绝访问各个权限，但是当功能因此而中断时，他们可能仍会感到惊讶。**最好监控有多少用户拒绝权限请求（例如，使用 Google Analytics（分析）），以便重构应用以避免依赖该权限，或更好地解释应用需要此权限才能正常工作的原因**。

##### 增加了事务负担

系统将要求用户单独授予权限组的访问权限，而不是以集合的形式授予。这样一来，**最大程度降低请求的权限数量**就变得非常重要，因为数量多会增加用户授予权限的负担，并且会增大至少有一个请求被拒绝的概率。



#### 避免请求不必要的权限



##### 改用 intent

在许多情况下，要让应用执行某项任务，有两种方法供您选择。应用可以要求提供权限来自行执行该任务，也可以**使用 intent 让其他应用执行该任务**。可减少权限的授予。



##### 失去音频焦点后暂停媒体

在这种情况下，当用户接电话时，您的应用需要转入后台，只有在通话停止后才会重新获得焦点。



出现此类情况（例如，媒体播放器在通话期间静音或暂停）时，通常采用的方法是使用 `PhoneStateListener` 或监听 `android.intent.action.PHONE_STATE` 的广播，以监听通话状态有无变化。这种解决方法的问题是它需要 `READ_PHONE_STATE` 权限，这将强制用户授予对广泛的敏感数据（如用户的设备和 SIM 硬件 ID 以及来电的电话号码）的访问权限。

您可以通过为应用请求 `AudioFocus`，在没有 `READ_PHONE_STATE` 或 `MODIFY_PHONE_STATE` 权限的情况下检测用户是否在通话中，这么做不需要显式权限，因为它不访问敏感信息。只需将对音频放入后台所需的代码放入` onAudioFocusChange()` 事件处理程序，当操作系统转换其音频焦点时，它将自动运行。



##### 确定正在运行实例的设备

*在这种情况下，您需要一个唯一标识符来确定您的应用实例正在哪个设备上运行。*

应用可能具有设备特定的偏好设置或消息（例如，在云端为用户保存设备特定的播放列表，以便他们在车上和家里可以有不同的播放列表）。常见的解决方案是利用设备标识符（如 `Device IMEI`），但这需要 `Device ID and call information` 权限组（M+ 中为 `PHONE`）。它还使用一个无法重置且在所有应用之间共享的标识符。

下面两种方法可以替代这些类型的标识符：

1. 使用 `com.google.android.gms.iid` InstanceID API。`getInstance(Context context).getID()` 将为您的应用实例返回一个唯一设备标识符。结果是一个应用实例作用域标识符，在存储有关应用的信息时，该标识符可用作键，如果用户重新安装应用，该标识符会重置。
2. 使用 [`randomUUID()`](https://developer.android.com/reference/java/util/UUID.html#randomUUID()) 之类的基本系统函数创建您自己的标识符，其作用域限定为应用的存储空间。



##### 为广告或用户分析创建唯一标识符

*在这种情况下，您需要一个唯一标识符来为没有登录您应用的用户构建配置文件（例如，用于广告定位或衡量转化率）。*

为广告和用户分析构建配置文件有时需要一个在其他应用之间共享的标识符。此问题的常见解决方案需要利用设备标识符（如 `Device IMEI`），这需要 `Device ID` `and call information` 权限组（API 级别 23+ 中为 `PHONE`），并且无法由用户重置。无论是上述哪种情况，除了使用不可重置的标识符并请求用户可能认为不寻常的权限外，还会违反 [Play 开发者计划政策](https://play.google.com/about/developer-content-policy.html)。

遗憾的是，在这些情况下，使用 `com.google.android.gms.iid` InstanceID API 或系统函数创建应用作用域 ID 并不是适当的解决方案，因为可能需要在应用之间共享该 ID。一种替代解决方案是使用通过 `getId()` 方法从` AdvertisingIdClient.Info` 类中获取的 `Advertising Identifier`。您可以使用 `getAdvertisingIdInfo(Context)` 方法创建一个 `AdvertisingIdClient.Info` 对象，并调用 `getId()` 方法来使用该标识符。***请注意，此方法会产生阻塞***，因此，您不应从主线程调用它。



##### 8.0

如果您需要访问短信以接收身份验证码，从而防止用户被欺诈，请在应用说明和/或首次访问数据时告知用户。

###### 注意

如果应用面向 Android 8.0（API 级别 26）或更高版本，请不要在验证用户凭据过程中请求 [`READ_SMS`](https://developer.android.com/reference/android/Manifest.permission.html#READ_SMS) 权限，而应使用 `createAppSpecificSmsToken()` 生成应用特定的令牌，然后将此令牌传递给可以发送验证短信的其他应用或服务。



#### 测试两种权限模式

应测试以确保应用能正常运行，无论是否具有任何权限。

以下可帮助运行 API 级别 23 或更高级别的设备商找出与权限有关的代码问题：

- 确定应用的当前权限和相关的代码路径。

- 在各种受权限保护的服务和数据中测试用户流

- 使用授予或撤消权限的各种组合进行测试。

- 使用 [adb](https://developer.android.com/tools/help/adb.html) 工具从命令行管理权限：

  - 按组列出权限和状态

    ```shell
    adb shell pm list permission -d -g
    ```

  - 授予或撤消一项或多项权限

    ```shell
    adb shell pm [grant|revoke] <permission-name> ...
    ```

    

- 针对使用权限的服务对应用进行分析

